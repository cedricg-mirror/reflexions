SHA256 : 4e8f24fb50a08c12636f3d50c94772f355d5229e58110cccb3b4835cb2371aec  
source : https://blogs.jpcert.or.jp/en/2017/02/chches-malware--93d6.html  
sample source : https://bazaar.abuse.ch/sample/fd6a956a7708708cddff78c8505c7db73d7c4e961da8a3c00cc5a51171a92b7b/  
VT : https://www.virustotal.com/gui/file/fd6a956a7708708cddff78c8505c7db73d7c4e961da8a3c00cc5a51171a92b7b/detection  

Network / C2 : http://zebra.wthelpdesk.com/


Analyzed sample is a 32bit malware attributed by various security engines to APT10 and named ChChes

Runtime analysis results are shared in a filtered format only :

- filtered_log.txt which contains an execution trace filtered from various API calls in order to provide a better reading experience


*** Commentary *** 

Analyzed sample contains a few point of interest :

---- 

GetProcAddress :

```php
Monitoring: [pid 0x7dc][tid 0x5d8] c:\users\user\desktop\test\apt10.exe
Monitoring: [API]  <GetProcAddress> in [KERNEL32.DLL] 
Parameter : HMODULE hModule    : 0x76870000 (USER32.dll)
Parameter : LPCSTR  lpProcName : 0x76878866 ("wsprintfW")
Return  @ : 0xe802e4
```

The address of the required function name is located within User32.dll.  
This type of behaviour is usually encountered with some shellcodes which rely on CRC to locate required functions.  
Here, the authors of the malware seem to have come up with a half-baked approach where strings are dynamically retrieved within legitimate DLL while still relying on GetProcAddress to resolve the address.



---- 

Cookie :

Before encryption:
```php
Monitoring: [pid 0x7dc][tid 0x5d8] c:\users\user\desktop\test\apt10.exe
Monitoring: [API]  <lstrlen> in [KERNEL32.DLL] 
Parameter : LPCTSTR lpString : 0x1089168
            -> "Cookie: sSI0PV9d=sSI0PV9dAHOME*2012?3618468394?C:\Users\user\AppData\Local\Temp?1.4.1 (1690x950)*6.3.9600.17415"
Return  @ : 0xe8c7bd
```

After encryption :

```php
Monitoring: [pid 0x7dc][tid 0x5d8] c:\users\user\desktop\test\apt10.exe
Monitoring: [API]  <HttpAddRequestHeadersA> in [wininet.dll] 
Parameter : HINTERNET hRequest        : 0xcc000c
Parameter : LPCSTR    lpszHeaders     : 0x10ae518
            -> "Cookie: 6g2obw=LNbE3cY1QMetsxXDkQyLXkxLFA%3D%3D;rjawQQSR=OgITLoCFfO%2BI5dXd4P3%2BrlIZl%2FmOM7zVVqohY"
               "mM7;OtquvnsElZI=K3TgXQ3e5%2FY6FH4mgh%2BDB1LaUMe363QeNoAqvU5Srg%3D%3D;0G50bg=0fiStXhYqOitqYmTopooa561"
               "hkl1rA%3D%3D;ezcS=S%2BRtexAZraODSi7%2BBmnvg1s%3D;6CjD1w=zo1m4ZNcchY%3D"
               "Accept: */*"
               "Accept-Encoding: gzip, deflate"
Parameter : DWORD     dwHeadersLength : 0x13d
Parameter : DWORD     dwModifiers     : 0xa0000000 (HTTP_ADDREQ_FLAG_ADD | HTTP_ADDREQ_FLAG_REPLACE)
Return  @ : 0xe857e2
```

As mentionned in various reports, relevant data are uploaded by the malware through encrypted Cookies.

---- 

Proxy configuration :

```php
Monitoring: [pid 0x7dc][tid 0x5d8] c:\users\user\desktop\test\apt10.exe
Monitoring: [API]  <FindFirstFileW> in [KERNEL32.DLL] 
Parameter : LPCWSTR lpFileName : 0x10a7bd0
            -> "C:\Users\user\AppData\Roaming\Mozilla\Firefox\*"
Return  @ : 0xe836e2
```

```php
Monitoring: [pid 0x7dc][tid 0x5d8] c:\users\user\desktop\test\apt10.exe
Monitoring: [API]  <lstrcmpiW> in [KERNEL32.DLL] 
Parameter : LPWSTR lpString1 : 0xd9f000
            -> "prefs.js"
Parameter : LPWSTR lpString2 : 0xd9e68c
            -> "addons.json"
Return  @ : 0xe837bd
```

```php
Monitoring: [pid 0x7dc][tid 0x5d8] c:\users\user\desktop\test\apt10.exe
Monitoring: [API]  <StrStrW> in [shell32.dll] 
Parameter : PCWSTR pszFirst : 0x10c2728
            -> "// Mozilla User Preferences"
               ""
               "// DO NOT EDIT THIS FILE."
               "//"
               "// If you make changes to this file while the application is running,"
               "// the changes will be overwritten when the application exits."
               "//"
               "// To change a preference value, you can either:"
               "// - modify it via the UI (e.g. via about:config in the browser); or"
               "// - set it within a user.js file in your profile."
               ""
               "user_pref("accessibility.typeaheadfind.flashBar", 0);"
               "user_pref("app.normandy.first_run", false);"
               "user_pref("app.normandy.migrationsApplied", 12);"
               "user_pref("app.normandy.startupRolloutPrefs.app.normandy.onsync_skew_sec", 3300);"
               "user_pref("app.normandy.startupRolloutPrefs.extensions.fxmonitor.enabled", true);"
				[...]
Parameter : PCWSTR pszSrch  : 0xd9ef7c
            -> ""network.proxy.type","
Return  @ : 0xe81fcd
```

After unsuccessful connection attempts to it's C2, the malware in going to look for clues regarding a required proxy configuration in the "prefs.js" file from Firefox